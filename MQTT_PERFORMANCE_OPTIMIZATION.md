# Оптимизация производительности MQTT модуля gsp-aircond-modbus

## Проблемы, которые были исправлены:

### 1. Множественные обработчики MQTT сообщений
**Проблема:** Каждый вызов `subscribe()` добавлял новый обработчик `message`, что приводило к множественной обработке одного сообщения.

**Решение:** 
- Добавлена централизованная обработка сообщений в `MqttService`
- Используется массив `handlers` для отслеживания обработчиков
- Проверка на дублирование подписок

### 2. Частые WebSocket отправки
**Проблема:** Каждое MQTT сообщение сразу вызывало `pushToFrontend()`, что приводило к частым WebSocket отправкам.

**Решение:**
- Добавлен throttling с задержкой 1 секунда между обновлениями
- Используется `scheduleUpdate()` для группировки обновлений
- Принудительные обновления для команд управления

### 3. Отсутствие принудительных обновлений
**Проблема:** После команд управления не было немедленного обновления состояния.

**Решение:**
- Добавлен метод `forceUpdate()` для принудительных обновлений
- Команды управления вызывают принудительное обновление через 500ms

### 4. Отсутствие retry логики
**Проблема:** При разрыве MQTT соединения не было автоматического переподключения.

**Решение:**
- Добавлена retry логика с максимальным количеством попыток
- Автоматическое переподписывание на топики после переподключения
- Улучшенное логирование состояния подключения

## Ожидаемые улучшения:

1. **Снижение нагрузки на WebSocket** - за счет throttling
2. **Устранение дублирования обработки** - за счет централизованной обработки
3. **Быстрый отклик на команды** - за счет принудительных обновлений
4. **Стабильное MQTT подключение** - за счет retry логики
5. **Лучшее логирование** - для отслеживания производительности

## Конфигурация:

- **Throttling задержка:** 1000ms (1 секунда)
- **Принудительное обновление:** 500ms после команды
- **Retry попытки:** 5 раз с интервалом 5 секунд
- **Keepalive:** 60 секунд
- **Логирование:** DEBUG уровень для детального отслеживания

## Мониторинг:

### Логи для отслеживания производительности:
- `[MQTT] Получено сообщение:` - входящие MQTT сообщения
- `[WEBSOCKET] Отправка обновлений для X устройств` - WebSocket отправки
- `[DEVICE] AC_X: temp=X°C, setpoint=X°C, power=ON/OFF` - детали устройств
- `Планирование переподключения через Xms` - retry логика

### HTTP endpoints для мониторинга:
- `GET /mqtt/status` - статус MQTT подключения
- `GET /mqtt/health` - health check с деталями

## Команды для тестирования:

```bash
# Запуск сервера
npm run start:dev

# Мониторинг логов
tail -f logs/app.log | grep -E "(MQTT|WEBSOCKET|DEVICE)"

# Проверка подключений
netstat -an | grep :3001

# Тест производительности
node test-performance.js

# Проверка статуса MQTT
curl http://localhost:3001/mqtt/status

# Health check
curl http://localhost:3001/mqtt/health
```

## Типы обновлений:

### Обычные обновления (с throttling)
- Автоматические обновления от MQTT устройств
- Throttling: 1 секунда между обновлениями
- Логи: `[WEBSOCKET] Отправка обновлений для X устройств`

### Принудительные обновления (без throttling)
- Обновления после команд управления кондиционером
- Немедленная отправка через 500ms после команды
- Логи: `[WEBSOCKET] Отправка состояния X устройств к Y клиентам`

## Диагностика проблем:

### Если обновления приходят редко (раз в минуту):
1. Проверьте MQTT подключение: `curl http://localhost:3001/mqtt/status`
2. Проверьте логи на ошибки MQTT
3. Убедитесь, что MQTT брокер доступен
4. Проверьте подписки на топики

### Если обновления приходят слишком часто:
1. Проверьте throttling логи
2. Убедитесь, что нет дублирования обработчиков
3. Проверьте количество активных клиентов

### Если команды не выполняются:
1. Проверьте статус MQTT подключения
2. Проверьте логи публикации команд
3. Убедитесь, что топики команд правильные

## Дополнительные рекомендации:

1. **Мониторинг MQTT подключения:** Проверяйте статус подключения через `getConnectionStatus()`
2. **Логирование метрик:** Добавьте счетчики сообщений и времени отклика
3. **Обработка ошибок:** Добавьте retry логику для MQTT подключения
4. **Кэширование:** Рассмотрите кэширование последних состояний устройств
5. **Алерты:** Настройте уведомления при проблемах с MQTT подключением 