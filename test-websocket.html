<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>–¢–µ—Å—Ç WebSocket Modbus</title>
		<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 20px;
				background-color: #f5f5f5;
			}
			.container {
				max-width: 1200px;
				margin: 0 auto;
				background: white;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			.status {
				padding: 10px;
				margin: 10px 0;
				border-radius: 4px;
				font-weight: bold;
			}
			.connected { background-color: #d4edda; color: #155724; }
			.disconnected { background-color: #f8d7da; color: #721c24; }
			.device-card {
				border: 1px solid #ddd;
				margin: 10px 0;
				padding: 15px;
				border-radius: 4px;
				background-color: #f9f9f9;
			}
			.device-online { border-left: 4px solid #28a745; }
			.device-offline { border-left: 4px solid #dc3545; }
			.device-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 10px;
			}
			.device-name {
				font-weight: bold;
				font-size: 18px;
			}
			.device-status {
				padding: 4px 8px;
				border-radius: 4px;
				font-size: 12px;
				font-weight: bold;
			}
			.online { background-color: #28a745; color: white; }
			.offline { background-color: #dc3545; color: white; }
			.device-details {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 10px;
				margin-top: 10px;
			}
			.detail-item {
				background: white;
				padding: 8px;
				border-radius: 4px;
				border: 1px solid #eee;
			}
			.detail-label {
				font-weight: bold;
				color: #666;
				font-size: 12px;
			}
			.detail-value {
				font-size: 14px;
				margin-top: 4px;
			}
			.controls {
				margin: 20px 0;
				padding: 15px;
				background-color: #e9ecef;
				border-radius: 4px;
			}
			button {
				background-color: #007bff;
				color: white;
				border: none;
				padding: 10px 20px;
				margin: 5px;
				border-radius: 4px;
				cursor: pointer;
			}
			button:hover {
				background-color: #0056b3;
			}
			button:disabled {
				background-color: #6c757d;
				cursor: not-allowed;
			}
			.log {
				background-color: #f8f9fa;
				border: 1px solid #dee2e6;
				padding: 10px;
				margin-top: 20px;
				border-radius: 4px;
				max-height: 300px;
				overflow-y: auto;
				font-family: monospace;
				font-size: 12px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>–¢–µ—Å—Ç WebSocket Modbus</h1>
			
			<div id="connectionStatus" class="status disconnected">
				–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: –û—Ç–∫–ª—é—á–µ–Ω–æ
			</div>

			<div class="controls">
				<button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
				<button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
				<button onclick="subscribe()" id="subscribeBtn" disabled>–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
				<button onclick="unsubscribe()" id="unsubscribeBtn" disabled>–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
				<button onclick="pollAll()" id="pollBtn" disabled>–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –æ–ø—Ä–æ—Å</button>
				<button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
			</div>

			<div id="devicesContainer">
				<h2>–°–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2>
				<div id="devicesList">
					<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
				</div>
			</div>

			<div class="log">
				<h3>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</h3>
				<div id="logContainer"></div>
			</div>
		</div>

		<script>
			let socket = null;
			let isConnected = false;
			let isSubscribed = false;

			function log(message) {
				const logContainer = document.getElementById('logContainer');
				const timestamp = new Date().toLocaleTimeString();
				logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
				logContainer.scrollTop = logContainer.scrollHeight;
			}

			function clearLog() {
				document.getElementById('logContainer').innerHTML = '';
			}

			function updateConnectionStatus(connected) {
				const statusElement = document.getElementById('connectionStatus');
				isConnected = connected;
				
				if (connected) {
					statusElement.className = 'status connected';
					statusElement.textContent = '–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
					document.getElementById('subscribeBtn').disabled = false;
					document.getElementById('pollBtn').disabled = false;
				} else {
					statusElement.className = 'status disconnected';
					statusElement.textContent = '–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: –û—Ç–∫–ª—é—á–µ–Ω–æ';
					document.getElementById('subscribeBtn').disabled = true;
					document.getElementById('unsubscribeBtn').disabled = true;
					document.getElementById('pollBtn').disabled = true;
				}
			}

			function updateSubscriptionStatus(subscribed) {
				isSubscribed = subscribed;
				document.getElementById('subscribeBtn').disabled = subscribed;
				document.getElementById('unsubscribeBtn').disabled = !subscribed;
			}

			function connect() {
				if (socket) {
					socket.disconnect();
				}

				log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É...');
				socket = io('http://localhost:3000', {
					transports: ['websocket', 'polling']
				});

				socket.on('connect', () => {
					log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
					updateConnectionStatus(true);
				});

				socket.on('disconnect', () => {
					log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
					updateConnectionStatus(false);
					updateSubscriptionStatus(false);
				});

				socket.on('connect_error', (error) => {
					log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
					updateConnectionStatus(false);
				});

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
				socket.on('devicesState', (data) => {
					log(`üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (${data.devices.length} —É—Å—Ç—Ä–æ–π—Å—Ç–≤, ${data.clientCount} –∫–ª–∏–µ–Ω—Ç–æ–≤)`);
					updateDevicesDisplay(data.devices);
				});

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
				socket.on('deviceState', (data) => {
					log(`üì° –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${data.id}`);
					// –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
					updateSingleDevice(data);
				});

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
				socket.on('error', (data) => {
					log(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.message}`);
				});

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
				socket.on('commandSuccess', (data) => {
					log(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: ${data.command} –¥–ª—è ${data.deviceId}`);
				});

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–æ–º–∞–Ω–¥
				socket.on('commandError', (data) => {
					log(`‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–∞–Ω–¥—ã: ${data.message}`);
				});
			}

			function disconnect() {
				if (socket) {
					socket.disconnect();
					socket = null;
				}
			}

			function subscribe() {
				if (socket && isConnected) {
					socket.emit('subscribe');
					log('üìã –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤');
					updateSubscriptionStatus(true);
				}
			}

			function unsubscribe() {
				if (socket && isConnected) {
					socket.emit('unsubscribe');
					log('üìã –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤');
					updateSubscriptionStatus(false);
				}
			}

			function pollAll() {
				if (socket && isConnected) {
					log('üîÑ –ó–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–ø—Ä–æ—Å–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
					fetch('http://localhost:3000/modbus/poll-all', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						}
					})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							log(`‚úÖ ${data.message}`);
						} else {
							log(`‚ùå ${data.message}`);
						}
					})
					.catch(error => {
						log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
					});
				}
			}

			function updateDevicesDisplay(devices) {
				const container = document.getElementById('devicesList');
				
				if (!devices || devices.length === 0) {
					container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö</p>';
					return;
				}

				container.innerHTML = devices.map(device => `
					<div class="device-card ${device.isOnline ? 'device-online' : 'device-offline'}">
						<div class="device-header">
							<div class="device-name">${device.name}</div>
							<div class="device-status ${device.isOnline ? 'online' : 'offline'}">
								${device.isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
							</div>
						</div>
						<div class="device-details">
							<div class="detail-item">
								<div class="detail-label">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</div>
								<div class="detail-value">${device.mode || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
								<div class="detail-value">${device.isOn ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–£—Å—Ç–∞–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
								<div class="detail-value">${device.setTemperature}¬∞C</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞</div>
								<div class="detail-value">${device.fanSpeed}</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞</div>
								<div class="detail-value">${device.temperature}¬∞C</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–¥—ã</div>
								<div class="detail-value">${device.waterTemperature}¬∞C</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–°—Ç–∞—Ç—É—Å –ø–æ–º–ø—ã</div>
								<div class="detail-value">${device.pumpStatus ? '–†–∞–±–æ—Ç–∞–µ—Ç' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'}</div>
							</div>
							<div class="detail-item">
								<div class="detail-label">–°—Ç–∞—Ç—É—Å –∫–ª–∞–ø–∞–Ω–∞</div>
								<div class="detail-value">${device.valveStatus ? '–û—Ç–∫—Ä—ã—Ç' : '–ó–∞–∫—Ä—ã—Ç'}</div>
							</div>
						</div>
					</div>
				`).join('');
			}

			function updateSingleDevice(device) {
				// –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
				const existingCard = document.querySelector(`[data-device-id="${device.id}"]`);
				if (existingCard) {
					// –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É
					const newCard = createDeviceCard(device);
					existingCard.replaceWith(newCard);
				} else {
					// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
					const container = document.getElementById('devicesList');
					const newCard = createDeviceCard(device);
					container.appendChild(newCard);
				}
			}

			function createDeviceCard(device) {
				const card = document.createElement('div');
				card.className = `device-card ${device.isOnline ? 'device-online' : 'device-offline'}`;
				card.setAttribute('data-device-id', device.id);
				
				card.innerHTML = `
					<div class="device-header">
						<div class="device-name">${device.name}</div>
						<div class="device-status ${device.isOnline ? 'online' : 'offline'}">
							${device.isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
						</div>
					</div>
					<div class="device-details">
						<div class="detail-item">
							<div class="detail-label">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</div>
							<div class="detail-value">${device.mode || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
							<div class="detail-value">${device.isOn ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–£—Å—Ç–∞–≤–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã</div>
							<div class="detail-value">${device.setTemperature}¬∞C</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞</div>
							<div class="detail-value">${device.fanSpeed}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–∑–¥—É—Ö–∞</div>
							<div class="detail-value">${device.temperature}¬∞C</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–¥—ã</div>
							<div class="detail-value">${device.waterTemperature}¬∞C</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–°—Ç–∞—Ç—É—Å –ø–æ–º–ø—ã</div>
							<div class="detail-value">${device.pumpStatus ? '–†–∞–±–æ—Ç–∞–µ—Ç' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'}</div>
						</div>
						<div class="detail-item">
							<div class="detail-label">–°—Ç–∞—Ç—É—Å –∫–ª–∞–ø–∞–Ω–∞</div>
							<div class="detail-value">${device.valveStatus ? '–û—Ç–∫—Ä—ã—Ç' : '–ó–∞–∫—Ä—ã—Ç'}</div>
						</div>
					</div>
				`;
				
				return card;
			}

			// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
			window.onload = function() {
				log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é');
			};
		</script>
	</body>
</html>
